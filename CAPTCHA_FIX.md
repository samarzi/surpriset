# Исправление проблем с капчей и ошибками парсинга

## Исправленные проблемы:

### 1. ✅ Ошибка "body stream already read"
**Проблема:** Response читался дважды (в строках 64 и 68)  
**Решение:** Используем `response.clone()` для чтения ошибок

### 2. ✅ Капча Яндекс Маркет (SmartCaptcha)
**Проблема:** Яндекс Маркет блокирует автоматические запросы  
**Решение:** 
- Улучшен User-Agent и заголовки
- Скрыта автоматизация (`navigator.webdriver`)
- Добавлены случайные задержки (3-5 секунд)
- Убраны параметры из URL (которые могут вызывать капчу)
- Добавлена проверка на капчу с повторной попыткой

## Что изменилось:

### Frontend (`marketplaceParsers.ts`):
- Исправлено двойное чтение response
- Используется `response.clone()` для обработки ошибок

### Python парсеры:

**`base.py`:**
- Добавлен флаг `--disable-blink-features=AutomationControlled`
- Улучшены HTTP заголовки
- Добавлены случайные задержки (3-5 сек)
- Скрыт `navigator.webdriver`

**`yandex_market.py`:**
- Убираются параметры из URL перед запросом
- Добавлена проверка на капчу
- Автоматическая повторная попытка при обнаружении капчи

## Рекомендации:

1. **Используйте чистые URL** без параметров:
   ```
   ✅ https://market.yandex.ru/card/kholodilnik-dlya-napitkov-meyvel-md-04c3b-rgb/4705719999
   ❌ https://market.yandex.ru/card/.../4705719999?do-waremd5=...&cpc=...
   ```

2. **Если капча все еще появляется:**
   - Увеличьте задержки в `base.py` (строка 65)
   - Используйте headless=False для отладки
   - Рассмотрите использование прокси

3. **Для продакшена:**
   - Настройте ротацию User-Agent
   - Используйте прокси-серверы
   - Добавьте больше случайных задержек

## Тестирование:

```bash
# Перезапустите Python API сервер
pkill -f "python.*api_server"
source venv/bin/activate
python api_server.py

# Попробуйте импортировать товар через админ-панель
```

## Если проблема сохраняется:

1. Проверьте логи Python API:
   ```bash
   tail -f /tmp/api_server.log
   ```

2. Попробуйте другой товар с Яндекс Маркет

3. Используйте более простой URL без параметров
