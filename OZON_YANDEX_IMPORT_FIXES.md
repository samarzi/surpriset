# Исправления импорта с Ozon, Яндекс Маркет и Wildberries

## Дата: 26 января 2026

## Проблемы
1. **Ozon**: Цена 1329₽ импортировалась как 13.29₽
2. **Ozon, Яндекс и Wildberries**: Импортировалось только 1 фото вместо минимум 5

## Исправления

### 1. Исправление цены Ozon (`parsers/ozon_simple.py`)

**Проблема**: Неправильная логика конвертации - код делил цену на 100 если она больше 1000, считая что Ozon возвращает цену в копейках.

**Решение**: 
- Удалена неправильная конвертация из копеек
- Ozon API возвращает цены уже в рублях, не в копейках
- Теперь цена импортируется как есть: 1329₽ → 1329₽

**Код до**:
```python
if isinstance(price, (int, float)) and price > 0:
    if price > 1000:
        price = price / 100  # ❌ НЕПРАВИЛЬНО
    result["price"] = float(price)
```

**Код после**:
```python
if isinstance(price, (int, float)) and price > 0:
    # НЕ конвертируем из копеек - Ozon возвращает цену в рублях
    result["price"] = float(price)
```

### 2. Улучшение извлечения изображений Ozon

**Изменения**:
- Добавлена обработка дополнительных полей для URL изображений: `url`, `original`, `src`, `link`
- Улучшение качества изображений: замена размеров на максимальные (w2000/h2000)
- Удаление дубликатов изображений
- Улучшенная DOM fallback логика с 3 способами извлечения:
  1. Галерея товара (`[data-widget="webGallery"]`)
  2. Миниатюры галереи
  3. Все CDN изображения товара на странице
- Объединение изображений из JS и DOM (вместо замены)

**Код DOM fallback**:
```javascript
// Способ 1: Галерея товара
const galleryImgs = document.querySelectorAll('[data-widget="webGallery"] img, .product-page__gallery img, [class*="Gallery"] img');

// Способ 2: Миниатюры галереи
const thumbnails = document.querySelectorAll('[data-widget="webGallery"] button img, .product-gallery__thumbnail img');

// Способ 3: Все изображения с CDN Ozon
const allImgs = document.querySelectorAll('img[src*="cdn"], img[src*="ozon"]');
```

### 3. Улучшение извлечения изображений Яндекс Маркет

**Изменения**:
- Добавлена обработка дополнительных полей: `url`, `original`, `src`, `link`
- Улучшение качества изображений: замена размеров на максимальные (900x1200)
- Поддержка относительных URL (начинающихся с `//`)
- Улучшенная DOM fallback логика с 3 способами извлечения:
  1. Галерея товара (`[data-zone-name="productGallery"]`)
  2. Миниатюры галереи
  3. Все изображения с Яндекс CDN
- Объединение изображений из JS и DOM
- Добавлены debug логи для отслеживания количества изображений

**Код улучшения качества**:
```python
# Улучшаем качество изображений
url = url.replace('/200x200/', '/900x1200/').replace('/300x300/', '/900x1200/')
url = url.replace('/400x400/', '/900x1200/').replace('/500x500/', '/900x1200/')
```

### 5. Улучшение извлечения изображений Wildberries

**Изменения**:
- Добавлена обработка дополнительных полей: `fullSize`, `big`, `c516x688`, `url`
- Поддержка относительных URL (начинающихся с `//`)
- Удаление дубликатов изображений
- Улучшенная DOM fallback логика с 3 способами извлечения:
  1. Галерея товара (`.product-page__gallery`)
  2. Миниатюры с заменой на полноразмерные
  3. Все изображения с CDN Wildberries
- Объединение изображений из JS и DOM
- Добавлены debug логи

**Код замены миниатюр**:
```javascript
// Заменяем миниатюры на полноразмерные
src = src.replace('/tm/', '/big/').replace('/c246x328/', '/c516x688/');
```

### 6. Условие запуска DOM fallback

**Изменено**:
```python
# Было
if not result["title"] or result["price"] == 0 or not result["images"]:

# Стало
if not result["title"] or result["price"] == 0 or len(result["images"]) < 5:
```

Теперь DOM fallback запускается если найдено меньше 5 изображений, чтобы попытаться найти больше.

## Результаты

### Ozon
- ✅ Цена импортируется корректно (1329₽ → 1329₽)
- ✅ Извлекается до 10 изображений высокого качества
- ✅ Удаляются дубликаты
- ✅ Объединяются изображения из JS и DOM

### Яндекс Маркет
- ✅ Извлекается до 10 изображений высокого качества
- ✅ Поддержка относительных URL
- ✅ Улучшенное качество изображений (900x1200)
- ✅ Объединяются изображения из JS и DOM

### Wildberries
- ✅ Извлекается до 10 изображений высокого качества
- ✅ Обработка дополнительных полей (fullSize, big, c516x688)
- ✅ Улучшенная DOM fallback логика с 3 способами
- ✅ Замена миниатюр на полноразмерные изображения
- ✅ Объединяются изображения из JS и DOM

## Тестирование

Для тестирования используйте импорт в Telegram Mini App:
1. Откройте админ-панель в Telegram
2. Создайте новый товар
3. Вставьте ссылку на товар с Ozon, Яндекс Маркет или Wildberries
4. Нажмите "Загрузить"
5. Проверьте:
   - Цена корректная (особенно для Ozon)
   - Загружено минимум 5 изображений
   - Изображения высокого качества

## Примечания

- Импорт работает только в Telegram Mini App из-за ограничений CORS
- При запуске из браузера может появиться капча
- Максимум 10 изображений на товар
- Изображения автоматически улучшаются до максимального качества
