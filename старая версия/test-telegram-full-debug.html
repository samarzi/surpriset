<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Full Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: #fff;
            border: 2px solid #007acc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .error { border-color: #dc3545; background: #f8d7da; }
        .success { border-color: #28a745; background: #d4edda; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        .loading { border-color: #6c757d; background: #e2e3e5; }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
            font-size: 12px;
        }
        .status { font-weight: bold; margin: 5px 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .card { 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            padding: 10px;
            text-align: center;
        }
        .card img { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; }
        .banner { 
            width: 100%; 
            height: 150px; 
            background: linear-gradient(45deg, #007acc, #0056b3);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîç Telegram WebApp Full Debug Test</h1>
    
    <div class="debug-panel" id="env-check">
        <h3>üåç Environment Check</h3>
        <div class="status" id="env-status">Checking...</div>
        <pre id="env-details"></pre>
    </div>

    <div class="debug-panel" id="network-check">
        <h3>üåê Network Connectivity</h3>
        <div class="status" id="network-status">Testing...</div>
        <pre id="network-details"></pre>
    </div>

    <div class="debug-panel" id="products-check">
        <h3>üì¶ Products Loading</h3>
        <div class="status" id="products-status">Loading...</div>
        <pre id="products-details"></pre>
        <div class="grid" id="products-grid"></div>
    </div>

    <div class="debug-panel" id="banners-check">
        <h3>üéØ Banners Loading</h3>
        <div class="status" id="banners-status">Loading...</div>
        <pre id="banners-details"></pre>
        <div id="banners-container"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rmcedkzodiqcxnpenjld.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtY2Vka3pvZGlxY3hucGVuamxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzI4NzEsImV4cCI6MjA1MDU0ODg3MX0.Ej5Ej5Ej5Ej5Ej5Ej5Ej5Ej5Ej5Ej5Ej5Ej5Ej5E';

        function updateStatus(elementId, status, className) {
            const element = document.getElementById(elementId);
            element.textContent = status;
            element.parentElement.className = `debug-panel ${className}`;
        }

        function updateDetails(elementId, details) {
            document.getElementById(elementId).textContent = details;
        }

        // Environment Check
        async function checkEnvironment() {
            try {
                const isTelegram = window.Telegram && window.Telegram.WebApp;
                const userAgent = navigator.userAgent;
                const platform = navigator.platform;
                
                const envInfo = {
                    isTelegram,
                    userAgent,
                    platform,
                    telegramWebApp: isTelegram ? {
                        version: window.Telegram.WebApp.version,
                        platform: window.Telegram.WebApp.platform,
                        colorScheme: window.Telegram.WebApp.colorScheme,
                        isExpanded: window.Telegram.WebApp.isExpanded
                    } : null
                };

                updateStatus('env-status', isTelegram ? '‚úÖ Telegram WebApp Detected' : '‚ùå Not in Telegram', isTelegram ? 'success' : 'warning');
                updateDetails('env-details', JSON.stringify(envInfo, null, 2));
            } catch (error) {
                updateStatus('env-status', '‚ùå Environment Check Failed', 'error');
                updateDetails('env-details', error.message);
            }
        }

        // Network Check
        async function checkNetwork() {
            try {
                console.log('üîç Testing network connectivity...');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                    method: 'HEAD',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    updateStatus('network-status', '‚úÖ Network OK', 'success');
                    updateDetails('network-details', `Status: ${response.status}\nHeaders: ${JSON.stringify([...response.headers.entries()], null, 2)}`);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('network-status', '‚ùå Network Failed', 'error');
                updateDetails('network-details', error.message);
            }
        }

        // Products Check
        async function checkProducts() {
            try {
                console.log('üîç Testing products loading...');
                
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/products?is_featured=eq.true&status=eq.in_stock&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const products = await response.json();
                
                updateStatus('products-status', `‚úÖ Products Loaded: ${products.length}`, 'success');
                updateDetails('products-details', JSON.stringify(products, null, 2));

                // Render products
                const grid = document.getElementById('products-grid');
                grid.innerHTML = products.map(product => `
                    <div class="card">
                        <img src="${product.image_url || '/placeholder.jpg'}" alt="${product.name}" onerror="this.src='/placeholder.jpg'">
                        <h4>${product.name}</h4>
                        <p>${product.price} ‚ÇΩ</p>
                    </div>
                `).join('');

            } catch (error) {
                updateStatus('products-status', '‚ùå Products Failed', 'error');
                updateDetails('products-details', error.message);
            }
        }

        // Banners Check
        async function checkBanners() {
            try {
                console.log('üîç Testing banners loading...');
                
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/banners?is_active=eq.true&order=sort_order.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const banners = await response.json();
                
                updateStatus('banners-status', `‚úÖ Banners Loaded: ${banners.length}`, 'success');
                updateDetails('banners-details', JSON.stringify(banners, null, 2));

                // Render banners
                const container = document.getElementById('banners-container');
                container.innerHTML = banners.map(banner => `
                    <div class="banner" style="background-image: url('${banner.image_url}'); background-size: cover;">
                        ${banner.title || 'Banner'}
                    </div>
                `).join('');

            } catch (error) {
                updateStatus('banners-status', '‚ùå Banners Failed', 'error');
                updateDetails('banners-details', error.message);
            }
        }

        // Initialize Telegram WebApp if available
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }

        // Run all checks
        async function runAllChecks() {
            await checkEnvironment();
            await checkNetwork();
            await checkProducts();
            await checkBanners();
        }

        // Start checks after page load
        window.addEventListener('load', () => {
            setTimeout(runAllChecks, 500);
        });
    </script>
</body>
</html>