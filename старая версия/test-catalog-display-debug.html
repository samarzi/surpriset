<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .warning { border-color: #ff9800; background: #fff8f0; }
        .info { border-color: #2196F3; background: #f0f8ff; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .product-image {
            width: 100%;
            height: 120px;
            background: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞</h1>
        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—á–µ–º—É —Ç–æ–≤–∞—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ UI</p>

        <div class="test-section info">
            <h3>üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</h3>
            <div id="device-info"></div>
        </div>

        <div class="test-section">
            <h3>üîó –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase</h3>
            <button onclick="testConnection()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</button>
            <div id="connection-result"></div>
        </div>

        <div class="test-section">
            <h3>üì¶ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ (–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ç–æ–¥)</h3>
            <button onclick="testStandardProducts()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã (Supabase Client)</button>
            <div id="standard-result"></div>
        </div>

        <div class="test-section">
            <h3>üì± –¢–µ—Å—Ç –º–æ–±–∏–ª—å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h3>
            <button onclick="testMobileProducts()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã (Mobile REST)</button>
            <div id="mobile-result"></div>
        </div>

        <div class="test-section">
            <h3>üéØ –¢–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞</h3>
            <button onclick="testIntegratedProducts()">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã (Integrated Method)</button>
            <div id="integrated-result"></div>
        </div>

        <div class="test-section">
            <h3>üñºÔ∏è –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <div id="products-display"></div>
        </div>

        <div class="test-section">
            <h3>üìã –õ–æ–≥–∏</h3>
            <button onclick="clearLogs()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ixqhqfqxqxqxqxqx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4cWhxZnF4cXhxeHF4cXgiLCJyb2xlIjoiYW5vbiIsImlhdCI6MTczNjg1NzIwMCwiZXhwIjoyMDUyNDMzMjAwfQ.placeholder';

        let allProducts = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666">[${timestamp}]</span> <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : type === 'warning' ? 'orange' : 'blue'}">[${type.toUpperCase()}]</span> ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function showDeviceInfo() {
            const info = {
                userAgent: navigator.userAgent,
                isMobile: /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()),
                isTelegram: !!(window.Telegram && window.Telegram.WebApp),
                isOnline: navigator.onLine,
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : 'Not available',
                screen: {
                    width: screen.width,
                    height: screen.height,
                    pixelRatio: window.devicePixelRatio
                }
            };

            document.getElementById('device-info').innerHTML = `
                <div><strong>User Agent:</strong> ${info.userAgent}</div>
                <div><strong>Mobile Device:</strong> ${info.isMobile ? '‚úÖ Yes' : '‚ùå No'}</div>
                <div><strong>Telegram WebApp:</strong> ${info.isTelegram ? '‚úÖ Yes' : '‚ùå No'}</div>
                <div><strong>Online Status:</strong> ${info.isOnline ? '‚úÖ Online' : '‚ùå Offline'}</div>
                <div><strong>Connection:</strong> ${JSON.stringify(info.connection)}</div>
                <div><strong>Screen:</strong> ${info.screen.width}x${info.screen.height} (${info.screen.pixelRatio}x)</div>
            `;

            log(`Device info: Mobile=${info.isMobile}, Telegram=${info.isTelegram}, Online=${info.isOnline}`);
        }

        async function testConnection() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = '<div>üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>';
            
            try {
                log('Testing Supabase connection...');
                const startTime = Date.now();
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/products?select=id&limit=1`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                const latency = Date.now() - startTime;

                if (response.ok) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ (${latency}ms)</div>`;
                    log(`Connection successful in ${latency}ms`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
                log(`Connection failed: ${error.message}`, 'error');
            }
        }

        async function testStandardProducts() {
            const resultDiv = document.getElementById('standard-result');
            resultDiv.innerHTML = '<div>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –º–µ—Ç–æ–¥–æ–º...</div>';
            
            try {
                log('Testing standard product loading...');
                const startTime = Date.now();
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/products?order=created_at.desc`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const products = await response.json();
                const latency = Date.now() - startTime;

                resultDiv.innerHTML = `<div class="success">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä–æ–≤ (${latency}ms)</div>`;
                log(`Standard method loaded ${products.length} products in ${latency}ms`, 'success');
                
                allProducts = products;
                displayProducts(products, 'standard');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                log(`Standard method failed: ${error.message}`, 'error');
            }
        }

        async function testMobileProducts() {
            const resultDiv = document.getElementById('mobile-result');
            resultDiv.innerHTML = '<div>üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã –º–æ–±–∏–ª—å–Ω—ã–º –º–µ—Ç–æ–¥–æ–º...</div>';
            
            try {
                log('Testing mobile-optimized product loading...');
                const startTime = Date.now();
                
                // Mobile-optimized request with specific filters
                const url = `${SUPABASE_URL}/rest/v1/products?status=eq.in_stock&order=created_at.desc&tags=not.cs.{__archive__}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const response = await fetch(url, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Connection': 'keep-alive'
                    }
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const products = await response.json();
                const latency = Date.now() - startTime;

                resultDiv.innerHTML = `<div class="success">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä–æ–≤ (${latency}ms)</div>`;
                log(`Mobile method loaded ${products.length} products in ${latency}ms`, 'success');
                
                allProducts = products;
                displayProducts(products, 'mobile');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                log(`Mobile method failed: ${error.message}`, 'error');
            }
        }

        async function testIntegratedProducts() {
            const resultDiv = document.getElementById('integrated-result');
            resultDiv.innerHTML = '<div>üîÑ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥...</div>';
            
            try {
                log('Testing integrated product loading method...');
                const startTime = Date.now();
                
                // Simulate the logic from database.ts productService.getAll()
                const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent.toLowerCase()) || 
                                 !!(window.Telegram && window.Telegram.WebApp);
                
                const filters = { search: '', tags: undefined }; // Basic catalog request
                const isBasicCatalogRequest = !filters.search && !filters.tags;
                
                log(`Device detection: isMobile=${isMobile}, isBasicRequest=${isBasicCatalogRequest}`);
                
                let products;
                let method;
                
                if (isBasicCatalogRequest && isMobile) {
                    // Use mobile-optimized method
                    log('Using mobile-optimized method for basic catalog request');
                    const url = `${SUPABASE_URL}/rest/v1/products?status=eq.in_stock&order=created_at.desc&tags=not.cs.{__archive__}`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Mobile method failed: HTTP ${response.status}`);
                    }
                    
                    products = await response.json();
                    method = 'mobile-optimized';
                } else {
                    // Use standard method
                    log('Using standard method');
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/products?order=created_at.desc`, {
                        method: 'GET',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Standard method failed: HTTP ${response.status}`);
                    }
                    
                    products = await response.json();
                    method = 'standard';
                }

                const latency = Date.now() - startTime;

                resultDiv.innerHTML = `<div class="success">‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä–æ–≤ –º–µ—Ç–æ–¥–æ–º "${method}" (${latency}ms)</div>`;
                log(`Integrated method (${method}) loaded ${products.length} products in ${latency}ms`, 'success');
                
                allProducts = products;
                displayProducts(products, 'integrated');
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
                log(`Integrated method failed: ${error.message}`, 'error');
            }
        }

        function displayProducts(products, source) {
            const displayDiv = document.getElementById('products-display');
            
            if (!products || products.length === 0) {
                displayDiv.innerHTML = `<div class="warning">‚ö†Ô∏è –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∏—Å—Ç–æ—á–Ω–∏–∫: ${source})</div>`;
                return;
            }

            const productsHtml = products.slice(0, 6).map(product => `
                <div class="product-card">
                    <div class="product-image">
                        ${product.images && product.images.length > 0 ? 
                            `<img src="${product.images[0]}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 4px;">` :
                            'üì¶'
                        }
                    </div>
                    <div><strong>${product.name}</strong></div>
                    <div>‚ÇΩ${product.price}</div>
                    <div style="font-size: 12px; color: #666;">ID: ${product.id}</div>
                    <div style="font-size: 12px; color: #666;">–°—Ç–∞—Ç—É—Å: ${product.status}</div>
                    <div style="font-size: 12px; color: #666;">–¢–µ–≥–∏: ${product.tags ? product.tags.join(', ') : '–ù–µ—Ç'}</div>
                </div>
            `).join('');

            displayDiv.innerHTML = `
                <h4>üì¶ –¢–æ–≤–∞—Ä—ã (–∏—Å—Ç–æ—á–Ω–∏–∫: ${source})</h4>
                <div>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: ${products.length}</div>
                <div class="product-grid">${productsHtml}</div>
                ${products.length > 6 ? `<div>... –∏ –µ—â–µ ${products.length - 6} —Ç–æ–≤–∞—Ä–æ–≤</div>` : ''}
            `;

            log(`Displayed ${Math.min(products.length, 6)} products from ${source}`, 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showDeviceInfo();
            log('Catalog display debug page loaded');
        });
    </script>
</body>
</html>